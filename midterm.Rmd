---
title: "Midterm_markdown"
output: html_document
date: "2023-09-29"
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```
## I. Data Wrangling
### Import packages and start the setting
```{r setup_packages, warning = FALSE, message = FALSE}
# Load Libraries
library(geos)
library(rsgeo)
library(tidyverse)
library(tidycensus)
library(sf)
library(kableExtra)
library(spdep)
library(caret)
library(ckanr)
library(FNN)
library(grid)
library(gridExtra)
library(ggcorrplot)


options(scipen=999)
options(tigris_class = "sf")

source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")
```

```{r load_key, warning = FALSE, eval = FALSE}
census_api_key("6a81f5ae68fcb8e26d2f0a80f4232c5e503b553d", overwrite = TRUE)
```
### Read Philadelphia block groups and housing prices
```{r}
Philly_block_groups <-
  st_read("https://opendata.arcgis.com/datasets/2f982bada233478ea0100528227febce_0.geojson") %>%
  st_transform('ESRI:102728')
  
Philly_price <-
  st_read("/Users/rachelren/Desktop/Upenn/MUSA_5080/Midterm/MUSA508_Midterm_Li_Ren/Data/studentData.geojson") %>%
  st_transform('ESRI: 102728') %>%
  filter(toPredict == "MODELLING") ## select data containing the sales price

Philly_price_clean <- Philly_price[, c("objectid", "census_tract", "exterior_condition", "number_of_rooms", "quality_grade", "sale_price", "year_built", "year_built_estimate", "geometry")] ## Select columns we use
```

### Read other variables in geojson format
```{r}
Shooting_victims <-
  st_read("/Users/rachelren/Desktop/Upenn/MUSA_5080/Midterm/MUSA508_Midterm_Li_Ren/Data/shootings.geojson") %>%
  st_transform('ESRI: 102728')

PPR_Sites <-
  st_read("/Users/rachelren/Desktop/Upenn/MUSA_5080/Midterm/MUSA508_Midterm_Li_Ren/Data/PPR_Program_Sites.geojson") %>%
  st_transform('ESRI: 102728')

Commercial_Corridors <-
  st_read("/Users/rachelren/Desktop/Upenn/MUSA_5080/Midterm/MUSA508_Midterm_Li_Ren/Data/Commercial_Corridors.geojson") %>%
  st_transform('ESRI: 102728')

schools <- 
  read.csv("/Users/rachelren/Desktop/Upenn/MUSA_5080/Midterm/MUSA508_Midterm_Li_Ren/Data/Schools.csv")

schools.sf <- 
  schools %>% 
  st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant") %>%
  st_transform('ESRI:102728')
```

### Get and clean the variables in the 2021 Census data
```{r results='hide'}
## all of the variables are in block group
blockgroup21 <-  
  get_acs(geography = "block group",
          variables = c("B19013_001E","B99051_005E",
                        "B01003_001E","B07201_003E",
                        "B07201_001E"), 
          year=2021, state=42,
          county=101, geometry=TRUE) %>% 
  st_transform('ESRI:102728')
```

```{r results='hide'}
variables2021_blockGroup <- load_variables(2021,'acs5') %>% 
dplyr::filter(geography == 'block group')

variables2021_tract <- load_variables(2021,'acs5') %>% 
dplyr::filter(geography == 'tract')
```

```{r results='hide'}
blockgroup21 <- 
  blockgroup21 %>%
  dplyr::select( -NAME, -moe) %>%
  spread(key = variable, value = estimate) %>%
  rename(TotalPop = B01003_001, 
         ForeignBorn = B99051_005,
         MedHHInc = B19013_001, 
         MobilityDifferentHouse = B07201_003,
         MobilityTotal = B07201_001
         )


# Let's create new rate variables using mutate

blockgroup21 <- 
  blockgroup21 %>%
  mutate(pctForeign = ifelse(TotalPop > 0, ForeignBorn / TotalPop, 0),
         pctMobility = ifelse(MobilityTotal > 0, (MobilityDifferentHouse / MobilityTotal), 0),
         year = "2021") %>%
  dplyr::select(-ForeignBorn,-MobilityDifferentHouse,-MobilityTotal,-TotalPop)
```

### Test the variables
```{r}
ggplot() +
  geom_sf(data = Philly_block_groups, fill = "grey40") +
  geom_sf(data = schools.sf, 
          show.legend = "point", size = .75) +
  mapTheme()
```
### Variable 1 (Neighborhood characteristics): Shooting incidents
Calculate the 5 average nearest neighbor distance for victims
```{r}
st_c <- st_coordinates

Shooting_victims <- 
  Shooting_victims %>%
  filter(!is.na(point_x)) %>%
  filter(!is.na(point_y))

Philly_price_clean <-
  Philly_price_clean %>% 
    mutate(
      shooting_nn5 = nn_function(st_c(Philly_price_clean), st_c(Shooting_victims), 5))
```

### Variable 2 (Neighborhood characteristics): School districts (Distance / enrollment / public private)
Calculate the distance of each house to the nearest schools
```{r}
nearest_school <- sf::st_nearest_feature(Philly_price_clean, schools.sf)

# convert to rsgeo geometries
x <- rsgeo::as_rsgeo(Philly_price_clean)
y <- rsgeo::as_rsgeo(schools.sf)

# calculate distance
Philly_price_clean$dist_to_school <- rsgeo::distance_euclidean_pairwise(x, y[nearest_school])
```
### Variable 3 (Neighborhood characteristics): Commercial Corridors
Calculate the distance of each house to the nearest commercial corridors
```{r}
nearest_Commercial <- sf::st_nearest_feature(Philly_price_clean, Commercial_Corridors)

# convert to rsgeo geometries
x <- rsgeo::as_rsgeo(Philly_price_clean)
y <- rsgeo::as_rsgeo(Commercial_Corridors)

# calculate distance
Philly_price_clean$dist_to_commerce <- rsgeo::distance_euclidean_pairwise(x, y[nearest_Commercial])
```

### Variable 4 (Neighborhood characteristics): Parks & Recreational Centers
Calculate the distance of each house to the nearest PPR
```{r}
nearest_PPR <- sf::st_nearest_feature(Philly_price_clean, PPR_Sites)

# convert to rsgeo geometries
x <- rsgeo::as_rsgeo(Philly_price_clean)
y <- rsgeo::as_rsgeo(PPR_Sites)

# calculate distance
Philly_price_clean$dist_to_PPR <- rsgeo::distance_euclidean_pairwise(x, y[nearest_PPR])
```
### Census variables: 
Merge the census data by block groups to the housing price dataset
```{r}
Philly_Housing_joined <- st_join(Philly_price_clean, blockgroup21, join = st_within)
```

### Test joined data map:
```{r}
ggplot() +
  geom_sf(data = blockgroup21, fill = "grey40") +
  geom_sf(data = Philly_Housing_joined, aes(colour = q5(sale_price)), 
          show.legend = "point", size = .75) +
  mapTheme()
```


